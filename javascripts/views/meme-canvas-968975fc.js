var headlineBase=0,nameBase=0;MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var e=document.createElement("canvas"),t=MEME.$("#meme-canvas");e&&e.getContext?(t.html(e),this.canvas=e,this.setDownload(),this.render()):t.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var e=document.createElement("a");"undefined"==typeof e.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function e(e){var t=l.background.height,a=l.background.width;if(t&&a){var n=t*d.imageScale,i=a*d.imageScale,o=d.backgroundPosition.x||d.width/2,h=d.backgroundPosition.y||d.height/2;e.drawImage(l.background,0,0,a,t,o-i/2,h-n/2,i,n)}}function t(e){d.overlayColor&&(e.save(),e.globalAlpha=1,e.fillStyle=d.themeData[d.theme].background,e.fillRect(0,0,d.width,d.height),e.globalAlpha=1,e.restore())}function a(e){var t=Math.round(.6*d.width),a=s+20,n=s+6;e.font=d.fontSize+"pt "+d.themeData[d.theme].headlineFont,e.fillStyle=d.themeData[d.theme].headline,e.textBaseline="top",d.textShadow&&(e.shadowColor="#666",e.shadowOffsetX=-2,e.shadowOffsetY=1,e.shadowBlur=10),"center"==d.textAlign?(e.textAlign="center",a=d.width/2,n=d.height-d.height/1.3,t=d.width-d.width/3):"right"==d.textAlign?(e.textAlign="left",a=d.width/2-2*s):e.textAlign="left";for(var i=d.headlineText.split("\n"),o=0;o<i.length;o++){var h=i[o].split(" "),l="";o>0&&(n+=Math.round(1.55*d.fontSize));for(var r=0;r<h.length;r++){var m=l+h[r]+" ",c=e.measureText(m),f=c.width;f>t&&r>0?(e.fillText(l,a,n-10),l=h[r]+" ",n+=Math.round(1.55*d.fontSize)):l=m}e.fillText(l,a,n-10)}e.shadowColor="transparent",headlineBase=n+Math.round(1.55*d.fontSize)-10}function n(e){var t,a,n,i;if(a=i=l.watermark.height,t=n=l.watermark.width,a&&t){var o=d.width*d.watermarkMaxWidthRatio;t>o&&(i=a*(o/t),n=o),e.globalAlpha=d.watermarkAlpha,e.drawImage(l.watermark,0,0,t,a,20,d.height-20-i,n,i),e.globalAlpha=1}}function i(e){if("left"==d.textAlign){switch(e.textAlign="left",e.fillStyle=d.themeData[d.theme].quote,d.themeData[d.theme].headlineFont){case'"SundayTimesModern-Medium"':case"SundayTimesModern-Medium":switch(d.fontSize){case"28":var t=s-24,a=s-26;break;default:var t=s-16,a=s-21}e.font="normal "+2.7*d.fontSize+"pt "+d.themeData[d.theme].headlineFont;break;case'"TimesModernCondensed-Bold"':case"TimesModernCondensed-Bold":switch(d.fontSize){case"28":var t=s-10,a=s-2;break;default:var t=s-8,a=s-5}e.font="normal "+2.7*d.fontSize+"pt "+d.themeData[d.theme].headlineFont;break;case'"TimesModernCondensed-Regular"':case"TimesModernCondensed-Regular":switch(d.fontSize){case"28":var t=s-10,a=s-4;break;default:var t=s-8,a=s-5}e.font="normal "+3.1*d.fontSize+"pt "+d.themeData[d.theme].headlineFont;break;default:switch(d.fontSize){case"28":var t=s-10;break;default:var t=s-4}var a=s-10;e.font="normal "+2.9*d.fontSize+"pt "+d.themeData[d.theme].headlineFont}e.fillText(d.quotemarkText,t,a)}}function o(e){e.fillStyle=d.themeData[d.theme].name,e.font="normal "+Math.round(.9*d.fontSize)+"pt "+d.themeData[d.theme].nameFont,nameBase=headlineBase+Math.round(2.2*d.nameSize);var t=s+20,a=headlineBase+4;"center"==d.textAlign?(e.textAlign="center",t=d.width/2):"right"==d.textAlign?(e.textAlign="left",t=d.width/2-2*s):e.textAlign="left",e.fillText(d.nameText,t,a)}function h(e){e.fillStyle=d.themeData[d.theme].credit,e.font="normal "+d.creditSize+"pt "+d.themeData[d.theme].font;var t=s+20,a=nameBase+4;"center"==d.textAlign?(e.textAlign="center",t=d.width/2):"right"==d.textAlign?(e.textAlign="left",t=d.width/2-2*s):e.textAlign="left",e.fillText(d.creditText,t,a)}if(this.canvas){var l=this.model,d=this.model.toJSON(),r=this.canvas.getContext("2d"),s=Math.round(d.width*d.paddingRatio);this.canvas.width=d.width,this.canvas.height=d.height,r.clearRect(0,0,d.width,d.height),t(r),e(r),a(r),n(r),i(r),o(r),h(r);var m=this.canvas.toDataURL();this.$("#meme-download").attr({href:m,download:(d.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(e){function t(e){e.preventDefault(),a.set("backgroundPosition",{x:o.x-(i.x-e.clientX),y:o.y-(i.y-e.clientY)})}if(e.preventDefault(),this.model.hasBackground()){var a=this.model,n=a.toJSON(),i=(a.background.width*n.imageScale/2,a.background.height*n.imageScale/2,{x:e.clientX,y:e.clientY}),o=n.backgroundPosition;o.x=o.x||n.width/2,o.y=o.y||n.height/2;var h=MEME.$(document).on("mousemove.drag",t).on("mouseup.drag",function(e){h.off("mouseup.drag mousemove.drag"),t(e)})}}});