var headlineBase=0,nameBase=0;MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var t=document.createElement("canvas"),e=MEME.$("#meme-canvas");t&&t.getContext?(e.html(t),this.canvas=t,this.setDownload(),this.render()):e.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var t=document.createElement("a");"undefined"==typeof t.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function t(t){var e=h.background.height,a=h.background.width;if(e&&a){var n=e*d.imageScale,i=a*d.imageScale,o=d.backgroundPosition.x||d.width/2,l=d.backgroundPosition.y||d.height/2;t.drawImage(h.background,0,0,a,e,o-i/2,l-n/2,i,n)}}function e(t){d.overlayColor&&(t.save(),t.globalAlpha=1,t.fillStyle=d.themeData[d.theme].background,t.fillRect(0,0,d.width,d.height),t.globalAlpha=1,t.restore())}function a(t){var e=Math.round(.6*d.width),a=s+20,n=s;t.font=d.fontSize+"pt "+d.fontFamily,t.fillStyle=d.themeData[d.theme].main,t.textBaseline="top",d.textShadow&&(t.shadowColor="#666",t.shadowOffsetX=-2,t.shadowOffsetY=1,t.shadowBlur=10),"center"==d.textAlign?(t.textAlign="center",a=d.width/2,n=d.height-d.height/1.5,e=d.width-d.width/3):"right"==d.textAlign?(t.textAlign="right",a=d.width-s):t.textAlign="left";for(var i=d.headlineText.split(" "),o="",l=0;l<i.length;l++){var h=o+i[l]+" ",r=t.measureText(h),m=r.width;m>e&&l>0?(t.fillText(o,a,n-10),o=i[l]+" ",n+=Math.round(1.5*d.fontSize)):o=h}t.fillText(o,a,n-10),t.shadowColor="transparent",headlineBase=n+Math.round(1.5*d.fontSize)-10}function n(t){var e,a,n,i;if(a=i=h.watermark.height,e=n=h.watermark.width,a&&e){var o=d.width*d.watermarkMaxWidthRatio;e>o&&(i=a*(o/e),n=o),t.globalAlpha=d.watermarkAlpha,t.drawImage(h.watermark,0,0,e,a,20,d.height-20-i,n,i),t.globalAlpha=1}}function i(t){switch(t.textAlign="left",t.fillStyle=d.themeData[d.theme].main,d.fontFamily){case"SundayTimesModern-Medium":var e=s-25;break;default:var e=s-10}t.font="normal "+2.7*d.fontSize+"pt "+d.fontFamily,t.fillText(d.quotemarkText,s-20,e)}function o(t){t.textAlign="left",t.fillStyle=d.themeData[d.theme].secondary,t.font="normal "+Math.round(1.5*d.nameSize)+"pt "+d.fontFamily,nameBase=headlineBase+Math.round(2.2*d.nameSize),t.fillText(d.nameText,s+20,headlineBase)}function l(t){t.textAlign="left",t.fillStyle=d.creditColor,t.font="normal "+d.creditSize+"pt "+d.fontFamily,t.fillText(d.creditText,s+20,nameBase)}if(this.canvas){var h=this.model,d=this.model.toJSON(),r=this.canvas.getContext("2d"),s=Math.round(d.width*d.paddingRatio);this.canvas.width=d.width,this.canvas.height=d.height,r.clearRect(0,0,d.width,d.height),e(r),t(r),a(r),n(r),i(r),o(r),l(r);var m=this.canvas.toDataURL();this.$("#meme-download").attr({href:m,download:(d.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(t){function e(t){t.preventDefault(),a.set("backgroundPosition",{x:o.x-(i.x-t.clientX),y:o.y-(i.y-t.clientY)})}if(t.preventDefault(),this.model.hasBackground()){var a=this.model,n=a.toJSON(),i=(a.background.width*n.imageScale/2,a.background.height*n.imageScale/2,{x:t.clientX,y:t.clientY}),o=n.backgroundPosition;o.x=o.x||n.width/2,o.y=o.y||n.height/2;var l=MEME.$(document).on("mousemove.drag",e).on("mouseup.drag",function(t){l.off("mouseup.drag mousemove.drag"),e(t)})}}});