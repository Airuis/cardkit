var headlineBase=0,nameBase=0;MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var e=document.createElement("canvas"),t=MEME.$("#meme-canvas");e&&e.getContext?(t.html(e),this.canvas=e,this.setDownload(),this.render()):t.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var e=document.createElement("a");"undefined"==typeof e.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function e(e){var t=d.background.height,a=d.background.width;if(t&&a){var n=t*s.imageScale,i=a*s.imageScale,o=s.backgroundPosition.x||s.width/2,l=s.backgroundPosition.y||s.height/2;e.drawImage(d.background,0,0,a,t,o-i/2,l-n/2,i,n)}}function t(e){s.overlayColor&&(e.save(),e.globalAlpha=1,e.fillStyle=s.themeData[s.theme].background,e.fillRect(0,0,s.width,s.height),e.globalAlpha=1,e.restore())}function a(e){var t=Math.round(.6*s.width),a=f+30,n=f+26;e.font=s.fontSize+"pt "+s.themeData[s.theme].headlineFont,e.fillStyle=s.themeData[s.theme].headline,e.textBaseline="top",s.textShadow&&(e.shadowColor="#666",e.shadowOffsetX=-2,e.shadowOffsetY=1,e.shadowBlur=10),"center"==s.textAlign?(e.textAlign="center",a=s.width/2,n=s.height-s.height/1.3,t=s.width-s.width/3):"right"==s.textAlign?(e.textAlign="left",a=s.width/2-2*f):e.textAlign="left";for(var i=s.headlineText.split("\n"),o=0;o<i.length;o++){var l=i[o].split(" "),h="";o>0&&(n+=Math.round(1.55*s.fontSize));for(var r=0;r<l.length;r++){var d=h+l[r]+" ",m=e.measureText(d),c=m.width;c>t&&r>0?(e.fillText(h,a,n-10),h=l[r]+" ",n+=Math.round(1.55*s.fontSize)):h=d}e.fillText(h,a,n-10)}e.shadowColor="transparent",headlineBase=n+Math.round(1.55*s.fontSize)-10}function n(e){var t,a,n,i;if(a=i=d.watermark.height,t=n=d.watermark.width,a&&t){var o=s.width*s.watermarkMaxWidthRatio;t>o&&(i=a*(o/t),n=o),e.globalAlpha=s.watermarkAlpha,e.drawImage(d.watermark,0,0,t,a,30,s.height-40-i,n,i),e.globalAlpha=1}}function i(e){if("left"==s.textAlign){switch(e.textAlign="left",e.fillStyle=s.themeData[s.theme].quote,s.themeData[s.theme].headlineFont){case'"SundayTimesModern-Medium"':case"SundayTimesModern-Medium":switch(s.fontSize){case"28":var t=f-14,a=f-6;break;default:var t=f-6,a=f-1}e.font="normal "+2.7*s.fontSize+"pt "+s.themeData[s.theme].headlineFont;break;case'"TimesModernCondensed-Bold"':case"TimesModernCondensed-Bold":switch(s.fontSize){case"28":var t=f,a=f+18;break;default:var t=f+2,a=f+15}e.font="normal "+2.7*s.fontSize+"pt "+s.themeData[s.theme].headlineFont;break;case'"TimesModernCondensed-Regular"':case"TimesModernCondensed-Regular":switch(s.fontSize){case"28":var t=f,a=f+16;break;default:var t=f+2,a=f+15}e.font="normal "+3.1*s.fontSize+"pt "+s.themeData[s.theme].headlineFont;break;default:switch(s.fontSize){case"28":var t=f-10;break;default:var t=f-4}var a=f+10;e.font="normal "+2.9*s.fontSize+"pt "+s.themeData[s.theme].headlineFont}e.fillText(s.quotemarkText,t,a)}}function o(e){e.fillStyle=s.themeData[s.theme].name,e.font="normal "+Math.round(.9*s.fontSize)+"pt "+s.themeData[s.theme].nameFont,nameBase=headlineBase+Math.round(2.2*s.nameSize);var t=f+30,a=headlineBase+4;"center"==s.textAlign?(e.textAlign="center",t=s.width/2):"right"==s.textAlign?(e.textAlign="left",t=s.width/2-2*f):e.textAlign="left",e.fillText(s.nameText,t,a)}function l(e){e.fillStyle=s.themeData[s.theme].credit,e.font="normal "+s.creditSize+"pt "+s.themeData[s.theme].font;var t=f+30,a=nameBase+4;"center"==s.textAlign?(e.textAlign="center",t=s.width/2):"right"==s.textAlign?(e.textAlign="left",t=s.width/2-2*f):e.textAlign="left",e.fillText(s.creditText,t,a)}function h(e){if(0!==s.roundelText.length&&s.roundel){var t=s.roundelPosition.x||s.width/2,a=s.roundelPosition.y||s.height/2,n=100;e.fillStyle=s.themeData[s.theme].roundelBackground,e.arc(t,a,n/2,0,2*Math.PI,!1),e.fill()}}function r(e){if(0!==s.roundelText.length&&s.roundel&&"undefined"!=typeof s.roundel){var t=16,a=-17,n=s.roundelPosition.x||s.width/2,i=s.roundelPosition.y||s.height/2;e.font="normal "+t+"pt "+s.themeData[s.theme].font,e.fillStyle=s.themeData[s.theme].roundelColor,e.textAlign="center";for(var o=60,l=s.roundelText.split(" "),h="",r=0;r<l.length;r++){var d=h+l[r]+" ",m=e.measureText(d),f=m.width;f>o&&r>0?(e.fillText(h,n,i+a),h=l[r]+" ",i+=Math.round(1.45*t)):h=d}e.fillText(h,n,i+a)}}if(this.canvas){var d=this.model,s=this.model.toJSON(),m=this.canvas.getContext("2d"),f=Math.round(s.width*s.paddingRatio);this.canvas.width=s.width,this.canvas.height=s.height,m.clearRect(0,0,s.width,s.height),t(m),h(m),r(m),e(m),a(m),n(m),i(m),o(m),l(m);var c=this.canvas.toDataURL();this.$("#meme-download").attr({href:c,download:(s.downloadName||"share")+".png"}),this.canvas.style.cursor=s.roundel||this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(e){function t(e){e.preventDefault(),a.set(i,{x:l.x-(o.x-e.clientX),y:l.y-(o.y-e.clientY)})}if(e.preventDefault(),this.model.hasBackground()||this.model.hasRoundel()){var a=this.model,n=a.toJSON();switch(n.dragging){case"background":var i="backgroundPosition",o={x:e.clientX,y:e.clientY},l=n.backgroundPosition;l.x=l.x||n.width/2,l.y=l.y||n.height/2;break;case"roundel":if(!this.model.hasRoundel())return;var i="roundelPosition",o={x:e.clientX,y:e.clientY},l=n.roundelPosition;l.x=l.x||n.width/2,l.y=l.y||n.height/2}var h=MEME.$(document).on("mousemove.drag",t).on("mouseup.drag",function(e){h.off("mouseup.drag mousemove.drag"),t(e)})}}});